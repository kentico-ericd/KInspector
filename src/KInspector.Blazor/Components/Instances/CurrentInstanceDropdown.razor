@using KInspector.Core.Helpers
@using KInspector.Core.Models
@using KInspector.Core.Services.Interfaces
@inject IInstanceService instanceService
@inject IConfigService configService
@inject NavigationManager navigationManager

@if (Instance is null)
{
    <button type="button"
        class="pointer-events-none text-gray-400 border border-gray-400 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2 dark:border-gray-600 dark:text-gray-400 dark:focus:ring-gray-800">
        Connected: None
    </button>
}
else
{
    <button id="currentInstanceButton" data-dropdown-toggle="dropdownInformation" type="button" data-dropdown-offset-distance="20" data-dropdown-offset-skidding="200"
        class="text-green-700 hover:text-white border border-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2 dark:border-green-500 dark:text-green-500 dark:hover:text-white dark:hover:bg-green-600 dark:focus:ring-green-800">
        Connected: @InstanceDetails.Site?.Name
    </button>
    <div id="dropdownInformation" class="instance-dropdown break-words z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow-lg dark:bg-gray-700 dark:divide-gray-600">
        <div class="px-4 py-3 text-sm text-gray-900 dark:text-white">
            <div class="mb-2 underline">
                <a href="https://@(InstanceDetails.Site?.DomainName)" target="_blank">Administration</a>
            </div>
            <ul class="text-left">
                <li>
                    Kentico version: @(InstanceDetails.AdministrationVersion)
                </li>
                <li>
                    Path: @Instance.AdministrationPath
                </li>
            </ul>
        </div>
        <div class="px-4 py-3 text-sm text-gray-900 dark:text-white">
            <div class="mb-2 underline">
                <a href="@InstanceDetails.Site?.PresentationUrl" target="_blank">Live site</a>
            </div
            <ul class="text-left">
                <li>
                    Kentico version: @(InstanceDetails.LiveSiteVersion)
                </li>
                <li>
                    Path: @Instance.LiveSitePath
                </li>
            </ul>
        </div>
        <div class="px-4 py-3 text-sm text-gray-900 dark:text-white">
            <div class="mb-2 underline">Database</div>
            <ul class="text-left">
                <li>
                    Kentico version: @(InstanceDetails.DatabaseVersion)
                </li>
                <li>
                    Database name: @DatabaseName
                </li>
                <li>
                    Server: @ServerName
                </li>
                <li>
                    Workstation: @sqlWorkstation
                </li>
                <li>
                    SQL version: @serverVersion
                </li>
            </ul>
        </div>
        <div class="py-2">
            <a href="#" @onclick="DisconnectInstance"
               class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-red-500">Disconnect</a>
        </div>
    </div>
}

@code {
    private InstanceDetails? instanceDetails;
    private string serverVersion = "Loading...";
    private string sqlWorkstation = "Loading...";

    [Parameter, EditorRequired]
    public Instance? Instance { get; set; }

    private InstanceDetails InstanceDetails => instanceDetails ??= instanceService.GetInstanceDetails(Instance);

    private string DatabaseName => DatabaseHelper.GetSqlConnection(Instance!.DatabaseSettings).Database;

    private string ServerName => DatabaseHelper.GetSqlConnection(Instance!.DatabaseSettings).DataSource;

    protected async override Task OnInitializedAsync()
    {
        if (Instance is not null)
        {
            var conn = DatabaseHelper.GetSqlConnection(Instance!.DatabaseSettings);
            await conn.OpenAsync();
            serverVersion = conn.ServerVersion;
            sqlWorkstation = conn.WorkstationId;
            await conn.DisposeAsync();
        }
    }

    private void DisconnectInstance()
    {
        configService.SetCurrentInstance(null);
        navigationManager.NavigateTo("/instances", true);
    }
}